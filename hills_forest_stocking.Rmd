---
title: "Hills Forest ReMapping"
author: "Summit-GIS"
date: "17/08/2023"
output: 
  pdf_document:
    toc: TRUE
    toc_depth: 5
    number_sections: FALSE
    df_print: tibble
    latex_engine: xelatex
  zotero: TRUE
---

```{r setup, echo=FALSE, message=FALSE,warning=FALSE, error=FALSE}
library(sf)
library(sp)
library(terra)
library(raster)
library(dplyr)
library(caret)
library(caretEnsemble)
library(ForestTools)
library(lidR)
library(randomForest)
library(e1071)
library(rgdal)
library(rgeos)
library(Rcpp)
library(rmarkdown)
library(knitr)
library(MASS)
library(car)
#devtools::install_github(("gearslaboratory/gdalUtils"))
library(gdalUtils)
#library(gdalUtilities)
#webshot::install_phantomjs(force = TRUE)
#knit_hooks$set(webgl = hook_webgl)
#knit_hooks$set(rgl.static = hook_rgl)
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, error=FALSE, message = FALSE)
set.seed(123)
```

## Action:

The following documents tasks undertaken to ReMap Hills Forest Area and identify changes from baseline datasets. Using LiDAR DEM and DSM, a canopy height model was derived from which a stem count was calculated according to Qi's algorithm (2020).

## 1. Input: Merge, Filter, & Align CRS to LiDAR

```{r, eval=FALSE}
# Merge chunks
filez_dem = list.files("~/Desktop/Summit_Forestry/dem", full.names = T, all.files = FALSE, pattern = '.tif$') 
filez_dsm = list.files("~/Desktop/Summit_Forestry/dsm", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list <- lapply(filez_dem, raster)
chm_raster_list <- lapply(filez_dsm, raster)
elev_raster = do.call(merge, c(elev_raster_list, tolerance = 1))
chm_raster = do.call(merge, c(chm_raster_list, tolerance = 1))
writeRaster(elev_raster, filename = "~/Desktop/Summit_Forestry/dem/elev_raster.tif", overwrite=TRUE)
writeRaster(chm_raster, filename = "~/Desktop/Summit_Forestry/dsm/chm_raster.tif", overwrite=TRUE)
elev_rast = terra::rast(elev_raster)
chm_rast = terra::rast(chm_raster)
terra::crs(elev_rast) 
terra::crs(chm_rast) 

hills_mask_sf = sf::read_sf("~/Desktop/Summit_Forestry/stands/hills_forest_bdry.shp")
hills_mask_rast = rasterize(vect(hills_mask_sf), chm_rast, touches = TRUE)
# OR hills_mask_rast = terra::resample(hills_mask_rast, elev_rast, method="near")
hills_mask_raster = raster::raster(hills_mask_rast)
writeRaster(hills_mask_raster, filename = "~/Desktop/Summit_Forestry/stands/hills_mask_raster.tif", overwrite=TRUE)
ggplot(hills_mask_sf) + geom_sf(aes(fill = 'red'), show.legend = FALSE)

hills_mask_rast = terra::resample(hills_mask_rast, elev_rast, method="near")
chm_rast = terra::resample(chm_rast, elev_rast, method="near")
elev_rast = terra::resample(elev_rast, hills_mask_rast, method="near")

# Apply Mask
elev = mask(elev_rast, hills_mask_rast, inverse=TRUE)
chm = mask(chm_rast, hills_mask_rast, inverse=TRUE)
elev_raster = raster::raster(elev)
chm_raster = raster::raster(chm)
writeRaster(elev_raster, filename = "~/Desktop/Summit_Forestry/dem/elev_raster.tif", overwrite=TRUE)
writeRaster(chm_raster, filename = "~/Desktop/Summit_Forestry/dsm/chm_raster.tif", overwrite=TRUE)

# CHEETSHEETS
# Align Projections, Resolution & Subclasses
## terra::crs(elev_rast) = "epsg:3005"
## elev_rast = terra::aggregate(elev_rast, fact = 100, fun = mean)

# Stack rasters & visualize
## covs_m1 = raster::stack(
##  chm_raster,
##  elev_raster, 
##  slope_raster,
##  species_raster)

## rasterVis::levelplot(covs_m1)
```

## 2. Input: Derive Stem Map using ITD algorithm and 95% Canopy Height

```{r, fig.show='hold', out.width="50%", eval=FALSE}
# jerry-rig with Plowrigths variable window function (North America Conifers)
wf_plowright<-function(x){ 
  a=0.05
  b=0.6 
  y<-a*x+b 
  return(y)}
heights <- seq(0,40,0.5)
window_plowright <- wf_plowright(heights)
plot(heights, window_plowright, type = "l", ylim = c(0,12), xlab="point elevation (m)", ylab="window diameter (m)", main='Plowright, 2018; y=0.05*x+0.6')
```

### Input: Height & Stems

```{r, eval=TRUE}
chm_raster = focal(chm_rast, w = kernel, fun = median, na.rm = TRUE) %>% raster()

slope_rast_quesnel = terra::terrain(elev_rast_quesnel, v="slope", unit="degrees", neighbors=8)
aspect_rast_quesnel = terra::terrain(elev_rast_quesnel, v="aspect", unit="degrees", neighbors=8)
asp_cos_rast_quesnel = cos((aspect_rast_quesnel*pi)/180)
asp_sin_rast_quesnel = sin((aspect_rast_quesnel*pi)/180)
writeRaster(elev_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/elev_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(slope_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/slope_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(asp_cos_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/asp_cos_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(asp_sin_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/asp_sin_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(lead_htop_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/lead_htop_raster_100m_quesnel.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="33%", echo=FALSE}
elev_rast_quesnel = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/elev_raster_100m_quesnel.tif")
lead_htop_rast_quesnel = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/lead_htop_raster_100m_quesnel.tif")
slope_rast_quesnel = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/slope_raster_100m_quesnel.tif")
asp_cos_rast_quesnel = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/asp_cos_raster_100m_quesnel.tif")
asp_sin_rast_quesnel = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/asp_sin_raster_100m_quesnel.tif")
terra::plot(elev_rast_quesnel)
terra::plot(slope_rast_quesnel)
terra::plot(asp_cos_rast_quesnel)
terra::plot(asp_sin_rast_quesnel)
terra::plot(lead_htop_rast_quesnel)
```

### 2.3. Quesnel Lake: Derive Species Raster

```{r, eval=FALSE}
lead_htop_sv_quesnel = as.polygons(lead_htop_rast_quesnel)
lead_htop_sf_quesnel = sf::st_as_sf(lead_htop_sv_quesnel)
vri_sf = read_sf("/media/seamus/128GB_WORKD/data/vector/vri/vri_tcc_lquan_20220627.shp")
#vri_species = vri_sf[c("SPECIES_CD", "SPECIES_PC")]
vri_species =  dplyr::filter(vri_sf, 
    SPECIES_CD=='PL' | SPECIES_CD=='PLI' | SPECIES_CD=='FD' | SPECIES_CD=='FDI' |
    SPECIES_CD=='SB' | SPECIES_CD=='SE' | SPECIES_CD=='SW' | SPECIES_CD=='SX' | 
    SPECIES_CD=='CW' | SPECIES_CD=='HW' | SPECIES_CD=='BL' | SPECIES_CD=='LW')
vri_species_allspecies = vri_species
vri_species_allspecies$SPECIES_CD = dplyr::recode(vri_species$SPECIES_CD, 
  PL = 0, PLI = 0, SB = 1, SE = 1, SW = 1, SX = 1, FD = 2, FDI = 2, CW = 3, HW = 4, BL = 5, LW = 6)
vri_species_allspecies = dplyr::rename(vri_species_allspecies, species_class = SPECIES_CD)
vri_species_allspecies = vri_species_allspecies["species_class"]
vri_species_allspecies_sf = sf::st_as_sf(vri_species_allspecies)
vri_species_aoi_quesnel = st_intersection(vri_species_allspecies_sf, st_make_valid(lead_htop_sf_quesnel))
species_class_rast_quesnel = terra::rasterize(vect(vri_species_aoi_quesnel), lead_htop_rast_quesnel, field = "species_class", touches = TRUE)
species_class_rast_quesnel = terra::resample(species_class_rast_quesnel, lead_htop_rast_quesnel)
species_class_raster_quesnel = raster::raster(species_class_rast_quesnel)
raster::writeRaster(species_class_raster_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/species_class_raster_100m_quesnel_allSpecies.tif", overwrite=TRUE)
```

```{r, echo=FALSE}
species_class_raster_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/unmasked-covariates/dem-based/species_class_raster_100m_quesnel_allSpecies.tif")
species_class_rast_quesnel = terra::rast(species_class_raster_quesnel)
terra::plot(species_class_rast_quesnel)
```

### 2.4. Quesnel Lake: Derive Mask to Include Estimates of "RESULTS, TCC_Blocks" Areas

```{r, fig.show='hold', out.width="25%", eval=FALSE}
#mask_burn2017 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Burn_Severity TCC_Burn_Severity_2017.shp")
#mask_burn2018 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Burn_Severity TCC_Burn_Severity_2018.shp")
#mask_burn2021 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Burn_Severity TCC_Burn_Severity_2021.shp")
#mask_burn2017 = mask_burn2017["BurnSev"]
#mask_burn2018 = mask_burn2018["BurnSev"]
#mask_burn2021 = mask_burn2021["BurnSev"]
#mask_burn2017 = dplyr::filter(mask_burn2017, BurnSev == 'High')
#mask_burn2018 = dplyr::filter(mask_burn2018, BurnSev == 'High')
#mask_burn2021 = dplyr::filter(mask_burn2021, BurnSev == 'High')
#mask_roads = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Roads.shp")
#mask_roads = sf::st_zm(mask_roads)
#mask_roads = sf::st_buffer(mask_roads, dist = 15, nQuadSegs = 5, endCapStyle = "ROUND", joinStyle = "ROUND", mitreLimit = 2)
#mask_roads_ften = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/FTEN_Roads_All.shp")
#mask_roads_ften = sf::st_zm(mask_roads_ften)
#mask_roads_ften = sf::st_buffer(mask_roads_ften, dist = 15, nQuadSegs = 5, endCapStyle = "ROUND", joinStyle = "ROUND", mitreLimit = 2)
#mask_clearcut = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/RSLT_CCRES_CLEAR.shp")
#mask_blocks = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Blocks_Join.shp")

#mask_burn2017_devBlocks_quesnel = sf::st_intersection(sf::st_make_valid(mask_burn2017), lead_htop_sf_quesnel)
#mask_burn2018_devBlocks_quesnel = sf::st_intersection(sf::st_make_valid(mask_burn2018), lead_htop_sf_quesnel)
#mask_burn2021_devBlocks_quesnel = sf::st_intersection(sf::st_make_valid(mask_burn2021), lead_htop_sf_quesnel)
#masks_df_devBlocks_quesnel = full_join(as_tibble(mask_burn2017_devBlocks_quesnel), as_tibble(mask_burn2018_devBlocks_quesnel), as_tibble(mask_burn2021_devBlocks_quesnel), by = "geometry")

#masks_sf_devBlocks_quesnel = st_as_sf(masks_df_devBlocks_quesnel) 
#mask_roads_devBlocks_quesnel = sf::st_intersection(mask_roads, st_make_valid(lead_htop_sf_quesnel))
#mask_roads_ften_devBlocks_quesnel = sf::st_intersection(mask_roads_ften, st_make_valid(lead_htop_sf_quesnel))
#masks_df_devBlocks_quesnel = full_join(as_tibble(masks_sf_devBlocks_quesnel), as_tibble(mask_roads_devBlocks_quesnel), as_tibble(mask_roads_ften_devBlocks_quesnel), by = 'geometry')
#masks_sf_devBlocks_quesnel = st_as_sf(masks_df_devBlocks_quesnel)
#masks_lquan_20220627 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/tcc_masks_lquan_20220627.shp")
masks_lquan_20220627 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/tcc_masks_lquan_quesnel_20220628.shp")
st_crs(masks_lquan_20220627) = 3005
#masks_sf_devBlocks_quesnel = sf::st_intersection(masks_lquan_20220627, st_make_valid(lead_htop_sf_quesnel))
masks_rast_devBlocks_quesnel = rasterize(vect(masks_lquan_20220627), lead_htop_rast_quesnel, touches = TRUE)
masks_raster_devBlocks_quesnel = raster::raster(masks_rast_devBlocks_quesnel)
writeRaster(masks_raster_devBlocks_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/mask/mask_raster_100m_devBlocks_quesnel_20220628.tif", overwrite=TRUE)
ggplot(masks_sf_devBlocks_quesnel) + geom_sf(aes(fill = 'red'), show.legend = FALSE)
```

```{r, echo=FALSE}
masks_raster_devBlocks_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/mask/mask_raster_100m_devBlocks_quesnel_20220628.tif")
masks_rast_devBlocks_quesnel = terra::rast(masks_raster_devBlocks_quesnel)
masks_sv_devBlocks_quesnel = as.polygons(masks_rast_devBlocks_quesnel)
masks_sf_devBlocks_quesnel = sf::st_as_sf(masks_sv_devBlocks_quesnel)
ggplot(masks_sf_devBlocks_quesnel) + geom_sf(aes(fill = 'red'), show.legend = FALSE)
```

### 2.5. Quesnel Lake: Apply Masking

```{r, eval=FALSE}
# mask by mask
lead_htop_rast_quesnel = terra::resample(lead_htop_rast_quesnel, elev_rast_quesnel)
masks_rast_devBlocks_quesnel = terra::resample(masks_rast_devBlocks_quesnel, elev_rast_quesnel)
species_class_rast_quesnel = terra::resample(species_class_rast_quesnel, elev_rast_quesnel)
lead_htop_rast_quesnel_masked = mask(lead_htop_rast_quesnel, masks_rast_devBlocks_quesnel, inverse=FALSE)
elev_rast_quesnel_masked = mask(elev_rast_quesnel, masks_rast_devBlocks_quesnel, inverse=FALSE)
slope_rast_quesnel_masked = mask(slope_rast_quesnel, masks_rast_devBlocks_quesnel, inverse=FALSE)
asp_cos_rast_quesnel_masked = mask(asp_cos_rast_quesnel, masks_rast_devBlocks_quesnel, inverse=FALSE)
asp_sin_rast_quesnel_masked = mask(asp_sin_rast_quesnel, masks_rast_devBlocks_quesnel, inverse=FALSE)
species_class_rast_quesnel_masked = mask(species_class_rast_quesnel, masks_rast_devBlocks_quesnel, inverse=FALSE)
# mask by species
lead_htop_rast_quesnel_masked = mask(lead_htop_rast_quesnel_masked, species_class_rast_quesnel_masked, inverse=FALSE)
elev_rast_quesnel_masked = mask(elev_rast_quesnel_masked, species_class_rast_quesnel_masked, inverse=FALSE)
slope_rast_quesnel_masked = mask(slope_rast_quesnel_masked, species_class_rast_quesnel_masked, inverse=FALSE)
asp_cos_rast_quesnel_masked = mask(asp_cos_rast_quesnel_masked, species_class_rast_quesnel_masked, inverse=FALSE)
asp_sin_rast_quesnel_masked = mask(asp_sin_rast_quesnel_masked, species_class_rast_quesnel_masked, inverse=FALSE)
# save outputs
writeRaster(lead_htop_rast_quesnel_masked, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/lead_htop_rast_quesnel_masked.tif", overwrite=TRUE)
writeRaster(elev_rast_quesnel_masked, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/elev_rast_quesnel_masked.tif", overwrite=TRUE)
writeRaster(slope_rast_quesnel_masked, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/slope_rast_quesnel_masked.tif", overwrite=TRUE)
writeRaster(asp_cos_rast_quesnel_masked, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/asp_cos_rast_quesnel_masked.tif", overwrite=TRUE)
writeRaster(asp_sin_rast_quesnel_masked, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/asp_sin_rast_quesnel_masked.tif", overwrite=TRUE)
writeRaster(species_class_rast_quesnel_masked, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/species_class_rast_quesnel_masked.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="33%", echo=FALSE}
lead_htop_rast_quesnel_masked = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/lead_htop_rast_quesnel_masked.tif")
elev_rast_quesnel_masked = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/elev_rast_quesnel_masked.tif")
slope_rast_quesnel_masked = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/slope_rast_quesnel_masked.tif")
asp_cos_rast_quesnel_masked = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/asp_cos_rast_quesnel_masked.tif")
asp_sin_rast_quesnel_masked = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/asp_sin_rast_quesnel_masked.tif")
species_class_rast_quesnel_masked = terra::rast("/media/seamus/128GB_WORKD/data/raster/tcc/inputs/masked-covariates/dem-based/species_class_rast_quesnel_masked.tif")
terra::plot(lead_htop_rast_quesnel_masked)
terra::plot(elev_rast_quesnel_masked)
terra::plot(slope_rast_quesnel_masked)
terra::plot(asp_cos_rast_quesnel_masked)
terra::plot(asp_sin_rast_quesnel_masked)
terra::plot(species_class_rast_quesnel_masked)
```

### 2.6. Quesnel Lake: Stack and Tidy Covariates

```{r}
# Rename rasters
names(lead_htop_rast_quesnel_masked) = "lead_htop"
names(elev_rast_quesnel_masked) = "elev"
names(slope_rast_quesnel_masked) = "slope"
names(asp_cos_rast_quesnel_masked) = "asp_cos"
names(asp_sin_rast_quesnel_masked) = "asp_sin"
names(species_class_rast_quesnel_masked) = "species_class"
# transform spatRaster to raster
lead_htop_raster_quesnel_masked = raster::raster(lead_htop_rast_quesnel_masked)
elev_raster_quesnel_masked = raster::raster(elev_rast_quesnel_masked)
slope_raster_quesnel_masked = raster::raster(slope_rast_quesnel_masked)
asp_cos_raster_quesnel_masked = raster::raster(asp_cos_rast_quesnel_masked)
asp_sin_raster_quesnel_masked = raster::raster(asp_sin_rast_quesnel_masked)
species_class_raster_quesnel_masked = raster::raster(species_class_rast_quesnel_masked)
# stack rasters
covs_m1_quesnel = raster::stack(
  lead_htop_raster_quesnel_masked,
  elev_raster_quesnel_masked, 
  slope_raster_quesnel_masked,
  asp_cos_raster_quesnel_masked,
  asp_sin_raster_quesnel_masked,
  species_class_raster_quesnel_masked)
# visualize 
rasterVis::levelplot(covs_m1_quesnel)
```

### 2.7. Quesnel Lake: Modeling WSVHA Estimates with Random Forest Regression 

```{r, eval=FALSE}
wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks <- raster::predict(covs_m1_quesnel, tunedModel_rf_m1_full)
wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks$layer[wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks$layer <= 0] = 0
writeRaster(wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks, overwrite=TRUE,
  filename = "/media/seamus/128GB_WORKD/data/raster/tcc/outputs/wsvha/bootstrapped/wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks_20220715vV.tif")
plot(wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks, main="Quesnel WSVHA: Random Forest", cex.main=0.8, maxpixels=22000000)
hist(wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks, main="Quesnel WSVHA: Random Forest", cex.main=0.8, maxpixels=22000000) 
```

```{r, fig.show='hold', out.width="50%", echo=FALSE}
wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/outputs/wsvha/bootstrapped/wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks_20220715vV.tif")
plot(wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks, main="Quesnel Developed Blocks WSVHA", cex.main=0.8, maxpixels=22000000)
hist(wsvha_model1_randomForest_bootstrapped_demBased_100m_quesnelANDdevBlocks, main="Quesnel Developed Blocks WSVHA", cex.main=0.8, maxpixels=22000000) 
```

