---
title: "Hills Forest ReMapping"
author: "Summit-GIS"
date: "17/08/2023"
output: 
  github_document:
    toc: TRUE
    toc_depth: 5
    number_sections: FALSE
    df_print: tibble
---

```{r setup, echo=FALSE, message=FALSE,warning=FALSE, error=FALSE}
library(sf)
library(sp)
library(terra)
library(raster)
library(dplyr)
library(caret)
library(caretEnsemble)
library(ForestTools)
library(lidR)
library(randomForest)
library(e1071)
library(rgdal)
library(rgeos)
library(Rcpp)
library(rmarkdown)
library(knitr)
library(MASS)
library(car)
#devtools::install_github(("gearslaboratory/gdalUtils"))
library(gdalUtils)
#library(gdalUtilities)
#webshot::install_phantomjs(force = TRUE)
#knit_hooks$set(webgl = hook_webgl)
#knit_hooks$set(rgl.static = hook_rgl)
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, error=FALSE, message = FALSE)
set.seed(123)
# ShortCUt l.95
```

## Action:

Some notes on the data processing steps and mapping outputs completed in the remapping exercise of the Hills Forest Area. To map potential differences between official data layers and newly LiDAR-derived attributes, two variables were derived: 'Stocking Density (stem/ha)' & 'Age Class'. Using DEM and DSM datasets sourced from the LINZ website, a stem map was derived by applying a variable window algorithm and a default taper function. With the stem map feature, two rasters were calculated showing a canopy height model and stocking density per hectare. This allowed comparison with values at StandID level. 

```{r, fig.show='hold', out.width="50%", eval=TRUE, echo=FALSE}
dem_raster = raster::raster("~/Desktop/Summit_Forestry/dem/dem_filled.tif")
dsm_raster = raster::raster("~/Desktop/Summit_Forestry/dsm/dsm_filled.tif")
dem_rast = terra::rast(dem_raster)
dsm_rast = terra::rast(dsm_raster)
terra::crs(dem_rast) =  "epsg:2193"
terra::crs(dsm_rast) =  "epsg:2193"
terra::plot(dem_rast, main='DEM (Source: LINZ)') 
terra::plot(dsm_rast, main='DSM (Source: LINZ') 
```
## 1. Inputs: LiDAR Projection 

```{r, fig.show='hold', out.width="50%", eval=FALSE, echo=TRUE}
# Merge chunks
filez_dem = list.files("~/Desktop/Summit_Forestry/dem", full.names = T, all.files = FALSE, pattern = '.tif$') 
filez_dsm = list.files("~/Desktop/Summit_Forestry/dsm", full.names = T, all.files = FALSE, pattern = '.tif$') 
dem_raster_list <- lapply(filez_dem, raster)
dsm_raster_list <- lapply(filez_dsm, raster)
dem_raster = do.call(merge, c(dem_raster_list, tolerance = 1))
dsm_raster = do.call(merge, c(dsm_raster_list, tolerance = 1))
writeRaster(dem_raster, filename = "~/Desktop/Summit_Forestry/dem/dem_raster.tif", overwrite=TRUE)
writeRaster(dsm_raster, filename = "~/Desktop/Summit_Forestry/dsm/dsm_raster.tif", overwrite=TRUE)

# Rasterize and fill sinks
fill_sinks(dem = "dem_mosaic.tif", out = "dem_fill.tif", size = 1, overwrite = TRUE)
fill_sinks(dsm = "dsm_mosaic.tif", out = "dsm_fill.tif", size = 1, overwrite = TRUE)
writeRaster(dem_fill, filename = "~/Desktop/Summit_Forestry/dem/dem_filled.tif", overwrite=TRUE)
writeRaster(dsm_fill, filename = "~/Desktop/Summit_Forestry/dsm/dsm_filled.tif", overwrite=TRUE)

# Assign EPGS2193/NZGD2000
dem_rast = terra::rast(dem_filled)
dsm_rast = terra::rast(dsm_filled)
terra::crs(dem_rast) =  "epsg:2193"
terra::crs(dsm_rast) =  "epsg:2193"
terra::plot(dem_rast, main='DEM (Source: LINZ)') 
terra::plot(dsm_rast, main='DSM (Source: LINZ') 
```

## Input: Derive AOi & filter layers

```{r, fig.show='hold', out.width="50%", eval=TRUE, echo=TRUE}
# Derive mask from single cutblock shapefile: HILL-0341-009
mask_sf = sf::read_sf("~/Desktop/Summit_Forestry/stands/HILL-0341-009.shp")
mask_rast = rasterize(vect(mask_sf), dem_rast, touches = TRUE)
terra::crs(mask_rast) =  "epsg:2193"
ggplot(mask_sf) + geom_sf(aes(fill = 'red'), show.legend = FALSE)

# Align & apply mask
mask_rast = terra::resample(mask_rast, dsm_rast, method="near")
dem_rast = terra::resample(dem_rast, dsm_rast, method="near")
dem_masked = mask(dem_rast, mask_rast, inverse=FALSE)
dsm_masked = mask(dsm_rast, mask_rast, inverse=FALSE)
plot(dem_masked, main="DEM masked")
plot(dsm_masked, main = "DSM masked")

# Derive CHM & save as rasters
elev = dem_masked 
chm = dsm_masked - dem_masked
elev_raster = raster::raster(elev)
chm_raster = raster::raster(chm)
writeRaster(elev_raster, filename = "~/Desktop/Summit_Forestry/dem/elev_raster.tif", overwrite=TRUE)
writeRaster(chm_raster, filename = "~/Desktop/Summit_Forestry/dsm/chm_raster.tif", overwrite=TRUE)
plot(elev, main="Elevation (m)")
plot(chm, main="Canopy Height (m)")
```

## Input: Derive Variable Window Function

```{r, fig.show='hold', out.width="50%", eval=TRUE}
# Used Plowright's window function as temporary fix here: 
# https://cran.r-project.org/web/packages/ForestTools/vignettes/treetop_analysis.html
wf_plowright<-function(x){ 
  a=0.05
  b=0.6 
  y<-a*x+b 
  return(y)}
heights <- seq(0,40,0.5)
window_plowright <- wf_plowright(heights)
plot(heights, window_plowright, type = "l", ylim = c(0,12), xlab="point elevation (m)", ylab="window diameter (m)", main='Plowright, 2018; y=0.05*x+0.6')
```

## Input: Derive 95% Canopy Height & Stem Count Layers
```{r, eval=TRUE, fig.show='hold', out.width="33%", echo=FALSE, eval=TRUE}
stem_count_ha_raster = raster::raster(filename = "~/Desktop/Summit_Forestry/stands/stem_count_ha.tif")
chm_95height_raster = raster::raster(filename = "~/Desktop/Summit_Forestry/stands/chm_95height.tif")
plot(stem_count_ha_raster)
plot(chm_95height_raster)
```

```{r, eval=TRUE, fig.show='hold', out.width="33%", echo=TRUE, eval=FALSE}
kernel <- matrix(1,3,3)
chm_raster = focal(chm_rast, w = kernel, fun = median, na.rm = TRUE) %>% raster()
ttops_1.5mfloor_plowright = ForestTools::vwf(chm_raster, wf_plowright, 1.5)
writeOGR(ttops_1.5mfloor_plowright, "~/Desktop/Summit_Forestry/stands", "treetops_hills_009", driver = "ESRI Shapefile") 

quant95 <- function(x, ...) 
  quantile(x, c(0.95), na.rm = TRUE)
custFuns <- list(quant95, max)
names(custFuns) <- c("95thQuantile", "Max")

ttops_1.5mfloor_height <- ForestTools::sp_summarise(ttops_1.5mfloor_plowright, grid = 1, variables = "height", statFuns = custFuns)
chm_95height_raster = ttops_1.5mfloor_height[["height95thQuantile"]]
#chm_95height_rast = terra::rast(chm_95height_raster)
raster::writeRaster(chm_95height_raster, filename = "~/Desktop/Summit_Forestry/stands/chm_95height.tif", overwrite=TRUE)

stem_count_raster = ttops_1.5mfloor_height[["TreeCount"]]
raster::writeRaster(stem_count_raster, filename = "~/Desktop/Summit_Forestry/stands/stem_count.tif", overwrite=TRUE)
stem_count_rast = terra::rast("~/Desktop/Summit_Forestry/stands/stem_count.tif")
stem_count_ha_rast = stem_count_rast*100 #aggregate to 100m^2 for stems per hectare
stem_count_ha_rast
stem_count_ha_raster = as(stem_count_ha_rast, "SpatRaster")
raster::writeRaster(stem_count_ha_raster, filename = "~/Desktop/Summit_Forestry/stands/stem_count_ha.tif", overwrite=TRUE)

stem_count_ha_sf = st_as_sf(ttops_1.5mfloor_plowright)
mypalette<-brewer.pal(8,"Greens")
plot(chm_95height_raster, col = mypalette, alpha=0.6)
plot(st_geometry(stem_count_ha_sf["treeID"]), add=TRUE, cex = 0.001, pch=19, col = 'red', alpha=0.8) 

# Point Cloud Pipeline (or smaller areas with lighter memory tasks...)
## stem_count_sp = find_trees(chm_95height, lmf(wf_plowright), uniqueness = "bitmerge")
## stem_count_sf = st_as_sf(stem_count_sp)
## mypalette<-brewer.pal(8,"Greens")
## plot(chm_95height_raster, col = mypalette, alpha=0.6)
## plot(st_geometry(stem_count_sf["treeID"]), add=TRUE, cex = 0.001, pch=19, col = 'red', alpha=0.8)

# Point Cloud Pipeline: Check Tree-ID as proof of stem count...
## algo = dalponte2016(chm_95height_raster, stem_count_sp)
## chm_95h_segmented = segment_trees(chm_95height_raster, algo)
## chm_95h_segmented_crowns = delineate_crowns(chm_95h_segmented, type = 'convex')
## chm_95h_segmented_crowns_spplot = sp::plot(chm_95h_segmented_crowns, cex=0.000001, axes = TRUE, alpha=0.1)

# Point Cloud Pipeline: Derive raster
## chm_95h_segmented_crowns_sf = st_as_sf(chm_95h_segmented_crowns, coords = c("XTOP", "YTOP"), st_crs=2193)
## psych::describe(chm_95h_segmented_crowns_sf$treeID)
## raster_template = rast(ext(chm_95height_raster), resolution = 1, crs = st_crs(chm_95height_raster)$wkt)
## segmented_crowns_rast = rasterize(vect(chm_95h_segmented_crowns_sf), raster_template, fun = sum, touches = TRUE)
## stem_count_ha_rast = segmented_crowns_rast*100 #convert from 1m resolution 100m-sq fpr stems per hectare
## stem_count_ha_raster = raster::raster(stem_count_ha_rast, filename = "~/Desktop/Summit_Forestry/stands/stem_count_ha_raster.tif")
## stem_count_ha_raster = writeRaster(stem_count_ha_raster, filename = "~/Desktop/Summit_Forestry/stands/stem_count_ha_raster.tif", overwrite=TRUE)
## stem_count_ha_raster = raster::raster(stem_count_ha_rast, filename = "~/Desktop/Summit_Forestry/stands/stem_count_ha_raster.tif")
## plot(segmented_crowns_rast)
## plot(stem_count_ha_raster)
```



